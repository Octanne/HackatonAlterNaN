# Cube: Elementary scaling test

## Description

This testcase allows to check performance scaling.

The model is a simple cube. The left side is blocked and a displacement is forced
on the right side (using Dirichlet).
The behaviour is elastic and solved using the PETSc solver.

## Files

- `Cube_perf.py`: code_aster commands file.
- `run_bench.sh`: bash script to run the testcase with Slurm batch scheduler.

The mesh is auto-generated by code_aster.
The number of refinements can be defined with the `REFINE` environment variable.

## Execution

The testcase must be started from the `Cube_files` directory.

```bash
cd xxx/benchmarks/Cube_files
```

Check that all works as expected in few seconds with:

```bash
REFINE=3 sbatch --nodes=1 --ntasks-per-node=1 run_bench.sh
```

Or without the scheduler:

```bash
REFINE=3 /path/to/code_aster/install/bin/run_aster Cube_perf.py
# or with mpi:
REFINE=6 /path/to/code_aster/install/bin/run_aster -n 4 Cube_perf.py
```

Parameters can be increased to test the scalability of the model.
For example:

```bash
REFINE=6 sbatch --nodes=1 --ntasks-per-node=1 run_bench.sh
REFINE=6 sbatch --nodes=1 --ntasks-per-node=4 run_bench.sh

# 480 procs (because of nodes with 2x24 cores)
REFINE=8 sbatch --nodes=10 --ntasks-per-node=48 run_bench.sh
# 2016 procs
REFINE=8 sbatch --nodes=42 --ntasks-per-node=48 run_bench.sh

# 3072 procs
REFINE=9 sbatch --nodes=64 --ntasks-per-node=48 run_bench.sh
# more ...
```

| REFINE value | Number of nodes | Number of Degrees Of Freedom (DOF) |
|:------------:|:---------------:|:----------------------------------:|
|       3      |             729 |                              2 187 |
|       6      |         274 625 |                            823 875 |
|       7      |       2 146 689 |                          6 440 067 |
|       8      |      16 974 593 |                         50 923 779 |
|       9      |     135 005 697 |                        405 017 091 |

This table presents the tested combinations.
The output files provide detailed informations about the execution time in each step.

## Results of the tested combinations

Results on Cronos (Bull with 2x48 cores Intel(R) Xeon(R) Platinum 8260 CPU @ 2.40GHz Cascade Lake, network Mellanox Infiniband HDR100 PCIe 16x simple port, 192 Go per node).

With about 175.000 DOFs/proc (*weak scaling*[^weak-scaling-1]):

| Refinement       |       3 |       6 |          7 |          8 |           9 |
| :--------------- | ------: |-------: | ---------: | ---------: | ----------: |
| Number of cells  |     512 | 262 144 |  2 097 152 | 16 777 216 | 134 217 728 |
| Number of nodes  |     729 | 274 625 |  2 146 689 | 16 974 593 | 135 005 697 |
| Number of DOFs   |    2187 | 823 875 |  6 440 067 | 50 923 779 | 405 017 091 |
| Number of procs  |       1 |       5 |         36 |        288 |       2 304 |
| Nb of DOFs/proc  |    2187 | 164 775 |    178 890 |    176 818 |     175 788 |
| Build mesh       |    0.37 |   14.13 |      13.75 |      18.86 |      113.59 |
| Model            |    0.06 |    0.39 |       0.45 |       0.46 |        1.15 |
| Material         |    0.01 |    0.02 |       0.01 |       0.02 |        0.02 |
| Boundary conditions | 0.01 |    0.16 |       0.19 |       0.30 |        0.63 |
| Create matrix    |    0.02 |    1.25 |       1.43 |       1.45 |        1.47 |
| Numbering        |    0.01 |    0.93 |       1.48 |       2.14 |        2.73 |
| Assembly         |    0.01 |    0.94 |       1.17 |       1.70 |        2.19 |
| Build RHS        |    0.01 |    0.03 |       0.04 |       0.06 |        0.06 |
| Factorize / Precond. | 0.07 |    6.77 |      9.65 |      16.20 |       22.11 |
| Solve            |    0.01 |    2.26 |       5.27 |       9.76 |       12.89 |
| Total            |    0.60 |   26.86 |      33.44 |      50.95 |      156.84 |

With about 300.000 DOFs/proc (*weak scaling*):

| Refinement       |           6 |         7 |          8 |           9 |
| :--------------- | ----------: |---------: |----------: | ----------: |
| Number of cells  |     262 144 | 2 097 152 | 16 777 216 | 134 217 728 |
| Number of nodes  |     274 625 | 2 146 689 | 16 974 593 | 135 005 697 |
| Number of DOFs   |     823 875 | 6 440 067 | 50 923 779 | 405 017 091 |
| Number of procs  |           3 |        22 |        168 |       1 350 |
| Nb of DOFs/proc  |     274 625 |   292 730 |    303 117 |     300 012 |
| Build mesh       |       16.31 |     14.11 |      16.41 |       86.97 |
| Model            |        0.51 |      0.63 |       0.64 |        1.33 |
| Material         |        0.01 |      0.01 |       0.01 |        0.01 |
| Boundary conditions |     0.26 |      0.29 |       0.44 |        0.61 |
| Create matrix    |        2.02 |      2.28 |       2.44 |        2.46 |
| Numbering        |        1.42 |      1.86 |       2.88 |        3.61 |
| Assembly         |        1.56 |      1.80 |       2.61 |        3.42 |
| Build RHS        |        0.04 |      0.05 |       0.06 |        0.07 |
| Factorize / Precond. |   10.90 |     14.44 |      19.46 |       23.34 |
| Solve            |        3.39 |      6.23 |      15.78 |       20.33 |
| Total            |       36.43 |     41.71 |      60.73 |      142.15 |

With 50 millions of DOFs using more or less processes (*strong scaling*[^strong-scaling]):

| Refinement       |           8 |           8 |           8 |           8 |
| :--------------- | ----------: | ----------: | ----------: | ----------: |
| Number of cells  |  16 777 216 |  16 777 216 |  16 777 216 |  16 777 216 |
| Number of nodes  |  16 974 593 |  16 974 593 |  16 974 593 |  16 974 593 |
| Number of DOFs   |  50 923 779 |  50 923 779 |  50 923 779 |  50 923 779 |
| Number of procs  |         288 |         480 |       1 008 |       2 016 |
| Nb of DOFs/proc  |     176 818 |     106 091 |      50 519 |      25 259 |
| Build mesh       |       19.38 |       20.12 |       90.29 |      105.26 |
| Model            |        0.46 |        0.36 |        0.92 |        1.55 |
| Material         |        0.02 |        0.02 |        0.02 |        0.08 |
| Boundary conditions |     0.31 |        0.36 |        0.48 |       4.58* |
| Create matrix    |        1.46 |        0.89 |        0.46 |        0.24 |
| Numbering        |        2.20 |        1.53 |        0.88 |        1.22 |
| Assembly         |        1.82 |        1.18 |        0.61 |        0.43 |
| Build RHS        |        0.05 |        0.06 |        0.04 |        0.04 |
| Factorize / Precond. |   16.20 |       12.10 |        9.21 |        9.49 |
| Solve            |        9.66 |        7.41 |        3.83 |        2.90 |
| Total            |       51.57 |       44.02 |      106.73 |      125.80 |

*: Probably a one-time problem.

> Note about the line "Build mesh": The strategy changes with more than 512 processes.

[^weak-scaling-1]: https://hpc-wiki.info/hpc/Scaling#Weak_Scaling

[^strong-scaling]: https://hpc-wiki.info/hpc/Scaling#Strong_Scaling

## Variant using the *legacy* parallelism

By default, the testcase uses a parallel mesh that is distributed on all processes
(domain decomposition).

The *legacy* parallelism of code_aster can also be checked by defining
the `USE_LEGACY` environment variable:

```bash
REFINE=6 USE_LEGACY=1 SOLVER=PETSC sbatch --nodes=4 --ntasks-per-node=16 run_bench.sh
```

Testing using the MUMPS direct solver:

```bash
REFINE=6 USE_LEGACY=1 SOLVER=MUMPS sbatch --nodes=4 --ntasks-per-node=16 run_bench.sh
```

Some results with PETSc and MUMPS solvers (same cluster as previously):

| Refinement       |     6 PETSc |  6 PETSc |  6 PETSc |   6 Mumps |  6 Mumps |  6 Mumps |
| :--------------- | ----------: | -------: | -------: | --------: | -------: | -------: |
| Number of cells  |     262 144 |  262 144 |  262 144 |   262 144 |  262 144 |  262 144 |
| Number of nodes  |     274 625 |  274 625 |  274 625 |   274 625 |  274 625 |  274 625 |
| Number of DOFs   |     823 875 |  823 875 |  823 875 |   823 875 |  823 875 |  823 875 |
| Number of procs  |           4 |       48 |       96 |         4 |       48 |       96 |
| Nb of DOFs/proc  |     205 968 |   17 164 |    8 582 |   205 968 |   17 164 |    8 582 |
| Build mesh       |        7.03 |     7.72 |     7.72 |      6.99 |     7.70 |     7.70 |
| Model            |        3.63 |     3.93 |     4.21 |      3.69 |     4.21 |     4.39 |
| Material         |        0.02 |     0.01 |     0.01 |      0.01 |     0.01 |     0.01 |
| Boundary conditions |     0.66 |     0.67 |     0.67 |      0.66 |     0.67 |     0.67 |
| Create matrix    |        2.73 |     2.38 |     2.50 |      2.75 |     2.38 |     2.45 |
| Numbering        |        3.50 |     4.23 |     4.20 |      3.47 |     4.21 |     4.20 |
| Assembly         |        1.54 |     1.11 |     0.91 |      1.56 |     0.98 |     0.93 |
| Build RHS        |        0.08 |     0.10 |     0.09 |      0.08 |     0.09 |     0.09 |
| Factorize / Precond. |   14.06 |     3.60 |     2.24 |    134.29 |    33.52 |    26.41 |
| Solve            |        3.25 |     0.60 |     0.26 |     10.50 |     1.57 |     1.26 |
| Total            |       36.51 |    24.34 |    22.82 |    164.01 |    55.35 |    48.12 |
